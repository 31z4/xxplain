<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <title>SQL Input</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue3-sfc-loader/dist/vue3-sfc-loader.js"></script>
  <script src="https://unpkg.com/pev2/dist/pev2.umd.js"></script>
  <link href="https://unpkg.com/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/pev2/dist/pev2.css" />
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
    integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js"
    integrity="sha384-G/EV+4j2dNv+tEPo3++6LCgdCROaejBqfUeNjuKAiuXbjrxilcCdDz6ZAVfHWe1Y"
    crossorigin="anonymous"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .quiet {
      color: gray;
    }

    .sql-input {
      width: 100%;
      min-height: 200px;
      height: 80vh;
      font-family: monospace;
      padding: 10px;
      box-sizing: border-box;
    }
  </style>
</head>

<body data-bs-theme="">
  <div id="app" class="container">
    <div class="row">
      <div class="col col-6">
        <form class="d-flex flex-column">
          <div class="mb-3">
            <h2>Проанализируйте ваш SQL запрос</h2>
            <textarea id="id-sql-query" class="sql-input form-control" v-model="sql"
              placeholder="Введите SQL запрос..."></textarea>
          </div>
          <div class="d-flex align-items-baseline justify-content-end">
            <div class="form-check px-3">
              <input class="form-check-input" type="checkbox" value="" id="checkDefault" v-model="analyze_on">
              <label class="form-check-label" for="checkDefault">
                Analyze
              </label>
            </div>
            <button type="button" class="btn btn-primary" @click="send" :disabled="loading">
              <span v-if="loading" class="spinner-border spinner-border-sm" aria-hidden="true"></span>
              <span role="status">{{ loading ? 'Обрабатывается...' : 'EXPLAIN' }}</span>
            </button>
          </div>
        </form>
      </div>
      <div class="col col-6">
        <form class="d-flex flex-column">
          <div class="mb-3" v-if="!prediction">
            <h2 class="quiet">... или воспользуйтесь примерами</h2>
            <sql-card :title="sample.name" :sql="sample.sql" 
              @apply-sql="handleApply"
              v-for="(sample, index) in sql_samples"></sql-card>
          </div>
          <div class="mb-3" v-if="prediction">
            <h2>Анализ запроса</h2>
            <query-stats-table :prediction="prediction" :actual="actual"></query-stats-table>
          </div>
          <div class="mb-3" v-if="prediction">
            <div class="accordion" id="accordionExample">
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#collapse-plan" aria-expanded="true" aria-controls="collapse-plan">
                    Посмотреть план
                  </button>
                </h2>
                <div id="collapse-plan" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                  <div class="accordion-body">
                    <pev2 :plan-source="plan" :plan-query="sql"></pev2>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="mb-3" v-if="recommendation">
            <div v-if="recommendation?.query">
              <h2>Рекомендованный запрос</h2>
              <sql-card title="✨ Рекомендации" :sql="recommendation.query" @apply-sql="handleApply"></sql-card>
              <query-stats-table :prediction="recommendation?.prediction"></query-stats-table>
              <div class="mb-3">
                <div class="accordion" id="accordionExample">
                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapse-recommendation-plan" aria-expanded="true"
                        aria-controls="collapse-recommendation-plan">
                        Посмотреть план
                      </button>
                    </h2>
                    <div id="collapse-recommendation-plan" class="accordion-collapse collapse"
                      data-bs-parent="#accordionExample">
                      <div class="accordion-body">
                        <pev2 :plan-source="JSON.stringify(recommendation?.plan)" :plan-query="sql"></pev2>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <h2 v-else class="quiet">Нет рекомендаций</h2>
          </div>
      </div>
      <br>
    </div>

    <script>
      const { createApp } = Vue;
      const options = {
        moduleCache: {
          vue: Vue
        },
        async getFile(url) {

          const res = await fetch(url);
          if (!res.ok)
            throw Object.assign(new Error(res.statusText + ' ' + url), { res });
          return {
            getContentData: asBinary => asBinary ? res.arrayBuffer() : res.text(),
          }
        },
        addStyle(textContent) {

          const style = Object.assign(document.createElement('style'), { textContent });
          const ref = document.head.getElementsByTagName('style')[0] || null;
          document.head.insertBefore(style, ref);
        },
      }

      const { loadModule } = window['vue3-sfc-loader'];


      const app = createApp({
        components: {
          'query-stats-table': Vue.defineAsyncComponent( () => loadModule('./QueryStatsTable.vue', options) ),
          'sql-card': Vue.defineAsyncComponent( () => loadModule('./SqlCard.vue', options) )
        },
        setup() {
          const { ref } = Vue;
          
          // Реактивные переменные
          const sql = ref(localStorage.getItem('sql') || '');
          const loading = ref(false);
          const copied = ref(false);
          const applied = ref(false);
          const analyze_on = ref(false);
          
          // Статические данные
          const sql_samples = ref([
            {name: 'q01.sql', sql: `SELECT
    l_returnflag,
    l_linestatus,
    sum(l_quantity) AS sum_qty,
    sum(l_extendedprice) AS sum_base_price,
    sum(l_extendedprice * (1 - l_discount)) AS sum_disc_price,
    sum(l_extendedprice * (1 - l_discount) * (1 + l_tax)) AS sum_charge,
    avg(l_quantity) AS avg_qty,
    avg(l_extendedprice) AS avg_price,
    avg(l_discount) AS avg_disc,
    count(*) AS count_order
FROM
    lineitem
WHERE
    l_shipdate <= CAST('1998-09-02' AS date)
GROUP BY
    l_returnflag,
    l_linestatus
ORDER BY
    l_returnflag,
    l_linestatus;
`},
            {name: 'q22.sql', sql: `SELECT
    cntrycode,
    count(*) AS numcust,
    sum(c_acctbal) AS totacctbal
FROM (
    SELECT
        substring(c_phone FROM 1 FOR 2) AS cntrycode,
        c_acctbal
    FROM
        customer
    WHERE
        substring(c_phone FROM 1 FOR 2) IN ('13', '31', '23', '29', '30', '18', '17')
        AND c_acctbal > (
            SELECT
                avg(c_acctbal)
            FROM
                customer
            WHERE
                c_acctbal > 0.00
                AND substring(c_phone FROM 1 FOR 2) IN ('13', '31', '23', '29', '30', '18', '17'))
            AND NOT EXISTS (
                SELECT
                    *
                FROM
                    orders
                WHERE
                    o_custkey = c_custkey)) AS custsale
GROUP BY
    cntrycode
ORDER BY
    cntrycode;
`},
          ]);
          
          // Данные состояния
          const recommendation = ref(null);
          const prediction = ref(null);
          const actual = ref(null);
          const plan = ref(null);
          
          // Методы
          const send = async () => {
            localStorage.setItem('sql', sql.value);
            loading.value = true;
            try {
              const response = await fetch(`/explain${analyze_on.value ? '?analyze=1' : ''}`, {
                method: 'POST',
                body: sql.value
              });
              const data = await response.json();
              plan.value = JSON.stringify(data?.plan);
              recommendation.value = data?.recommendation;
              prediction.value = data?.prediction;
              actual.value = data?.actual;
            } catch (error) {
              console.error('Error:', error.message);
            } finally {
              loading.value = false;
            }
          };
          
          const copyToClipboard = (text) => {
            navigator.clipboard.writeText(text).then(() => {
              // Можно добавить визуальную обратную связь, например, изменить значок кнопки или показать уведомление
            });
            copied.value = true;
            setTimeout(() => {
              copied.value = false;
            }, 1000);
          };
          
          const applySQL = (text) => {
            console.log('applySql', text);
            sql.value = text;
            applied.value = true;
            setTimeout(() => {
              applied.value = false;
            }, 1000);
            document.getElementById('id-sql-query').focus();
          };
          
          const handleApply = (sqlText) => {
            applySQL(sqlText);
          };
          
          const formatDuration = (ms) => {
            if (ms < 0) ms = -ms;
            const time = {
              'дн': Math.floor(ms / 86400000),
              'ч': Math.floor(ms / 3600000) % 24,
              'мин': Math.floor(ms / 60000) % 60,
              'сек': Math.floor(ms / 1000) % 60,
              'мс': Math.floor(ms) % 1000,
            };
            return Object.entries(time)
              .filter(val => val[1] !== 0)
              .map(val => val[1] + ' ' + val[0])
              .join(', ');
          };
          
          return {
            sql,
            loading,
            copied,
            applied,
            analyze_on,
            sql_samples,
            recommendation,
            prediction,
            actual,
            plan,
            send,
            copyToClipboard,
            applySQL,
            handleApply,
            formatDuration
          };
        }
      });
      document.body.setAttribute('data-bs-theme', window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')
      app.component("pev2", pev2.Plan);

      app.mount('#app');
    </script>
</body>

</html>