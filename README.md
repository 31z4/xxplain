# xxplane

`EXPLAIN` –Ω–∞ —Å—Ç–µ—Ä–æ–∏–¥–∞—Ö.
–≠—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤, –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–≤ –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–π:

&nbsp;üîÆ –ü—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞ –¥–æ –µ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.<br>
&nbsp;üîé –ù–∞–≥–ª—è–¥–Ω–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –ø–ª–∞–Ω –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.<br>
&nbsp;üí° –î–∞—ë—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–∞.

–°–æ–≤–º–µ—Å—Ç–∏–º —Å [PostgreSQL](https://www.postgresql.org) –≤–µ—Ä—Å–∏–∏ 15 –∏ –≤—ã—à–µ.

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

–î–ª—è —Ä–∞–±–æ—Ç—ã –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è:

* [Docker Compose](https://docs.docker.com/compose/)
* [uv](https://docs.astral.sh/uv/)

–°–ª–µ–¥—É–π –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ.

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ë–î —Å —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏

–ü—Ä–æ–ø—É—Å—Ç–∏ —ç—Ç–æ—Ç —à–∞–≥, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å —Å–µ—Ä–≤–∏—Å –∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ë–î.

1. –°–æ–∑–¥–∞–π –ø–∞—Ä–æ–ª—å —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ `xxplain` –¥–ª—è Postgres:

    ```shell
    $ cat << EOF > .env.postgres
    POSTGRES_PASSWORD=super-secret
    POSTGRES_XXPLAIN_PASSWORD=top-secret
    EOF
    ```

2. –°–æ–∑–¥–∞–π —á–∏—Å—Ç—ã–π Docker volume –¥–ª—è Postgres –∏ –ø–∞–ø–∫—É –¥–ª—è –¥–∞–Ω–Ω—ã—Ö:

        make clean-docker-volumes
        mkdir data

3. –ó–∞–ø—É—Å—Ç–∏ Postgres:

        docker compose up -d postgres

4. –ó–∞–ø–æ–ª–Ω–∏ –ë–î —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏:

        ./scripts/gendata.sh

### 2. –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

1. –£–∫–∞–∂–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∫ –ë–î –∏ OpenAI —Å–æ–≤–º–µ—Å—Ç–∏–º–æ–º—É API:

    ```shell
    $ cat << EOF > .env.backend
    POSTGRES_DSN=postgresql://xxplain:top-secret@postgres/postgres

    OPENAI_API_KEY=secret-api-key
    OPENAI_API_BASE_URL=https://openrouter.ai/api/v1
    OPENAI_API_MODEL=openai/gpt-oss-20b:free
    EOF
    ```

2. –ó–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:

        docker compose up -d app

Web –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ [http://localhost:8000](http://localhost:8000).

‚ö†Ô∏è **–í–Ω–∏–º–∞–Ω–∏–µ** ‚ö†Ô∏è

–í —Ü–µ–ª—è—Ö –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –æ–±—É—á–µ–Ω–Ω—ã–µ –Ω–∞ —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –º–µ—Ç—Ä–∏–∫ –∑–∞–ø—Ä–æ—Å–∞.
–î–ª—è –ª—É—á—à–µ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–±—É—á–µ–Ω–∏–µ –Ω–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –∑–∞–ø—Ä–æ—Å–∞—Ö —Å —Ü–µ–ª–µ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã.

## API

–ö—Ä–æ–º–µ Web –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø—Ä–æ—Å—Ç–æ–π HTTP API.

**–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –±–µ–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**

    curl -X POST 'http://127.0.0.1:8000/explain' --data-binary 'select * from part'

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:

* **plan**: –ø–ª–∞–Ω –∑–∞–ø—Ä–æ—Å–∞
* **prediction**: –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∑–∞–ø—Ä–æ—Å–∞
    * **cost**: —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—É—á–µ–Ω–Ω–∞—è –æ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ Postgres
    * **cost_class**: –∫–ª–∞—Å—Å —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç 1 –¥–æ 5 (–≤—ã—à–µ ‚Äì –¥–æ—Ä–æ–∂–µ)
    * **total_time_ms**: –æ–±—â–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –≤ –º—Å–µ–∫.
    * **total_time_class**: –∫–ª–∞—Å—Å –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ (–≤—ã—à–µ - –¥–æ–ª—å—à–µ)
    * **data_read_bytes**: –æ–±—ä–µ–º —á–∏—Ç–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–π—Ç–∞—Ö
    * **data_read_class**: –∫–ª–∞—Å—Å –æ–±—ä–µ–º–∞ —á–∏—Ç–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–π—Ç–∞—Ö (–≤—ã—à–µ ‚Äì –±–æ–ª—å—à–µ)

**–í—ã–ø–æ–ª–Ω–∏—Ç—å –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å**

    curl -X POST 'http://127.0.0.1:8000/explain?analyze=1' --data-binary 'select * from part'

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:

* **plan**: –ø–ª–∞–Ω –∑–∞–ø—Ä–æ—Å–∞
* **prediction**: –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∑–∞–ø—Ä–æ—Å–∞
    * **cost**: —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—É—á–µ–Ω–Ω–∞—è –æ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ Postgres
    * **cost_class**: –∫–ª–∞—Å—Å —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç 1 –¥–æ 5 (–≤—ã—à–µ ‚Äì –¥–æ—Ä–æ–∂–µ)
    * **total_time_ms**: –æ–±—â–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –≤ –º—Å–µ–∫.
    * **total_time_class**: –∫–ª–∞—Å—Å –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ (–≤—ã—à–µ - –¥–æ–ª—å—à–µ)
    * **data_read_bytes**: –æ–±—ä–µ–º —á–∏—Ç–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–π—Ç–∞—Ö
    * **data_read_class**: –∫–ª–∞—Å—Å –æ–±—ä–µ–º–∞ —á–∏—Ç–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–π—Ç–∞—Ö (–≤—ã—à–µ ‚Äì –±–æ–ª—å—à–µ)
* **actual**: —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –∑–∞–ø—Ä–æ—Å–∞
    * **total_time_ms**: –æ–±—â–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –≤ –º—Å–µ–∫.
    * **total_time_class**: –∫–ª–∞—Å—Å –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ (–≤—ã—à–µ - –¥–æ–ª—å—à–µ)
    * **data_read_bytes**: –æ–±—ä–µ–º —á–∏—Ç–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–π—Ç–∞—Ö
    * **data_read_class**: –∫–ª–∞—Å—Å –æ–±—ä–µ–º–∞ —á–∏—Ç–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–π—Ç–∞—Ö (–≤—ã—à–µ ‚Äì –±–æ–ª—å—à–µ)

**–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å**

    curl -X POST 'http://127.0.0.1:8000/optimize' --data-binary @benchmarks/tpc-h/queries/q05.sql

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:

* **query**: –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
* **plan**: –ø–ª–∞–Ω –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
* **prediction**: –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    * **cost**: —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—É—á–µ–Ω–Ω–∞—è –æ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ Postgres
    * **cost_class**: –∫–ª–∞—Å—Å —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç 1 –¥–æ 5 (–≤—ã—à–µ ‚Äì –¥–æ—Ä–æ–∂–µ)
    * **total_time_ms**: –æ–±—â–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –≤ –º—Å–µ–∫.
    * **total_time_class**: –∫–ª–∞—Å—Å –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ (–≤—ã—à–µ - –¥–æ–ª—å—à–µ)
    * **data_read_bytes**: –æ–±—ä–µ–º —á–∏—Ç–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–π—Ç–∞—Ö
    * **data_read_class**: –∫–ª–∞—Å—Å –æ–±—ä–µ–º–∞ —á–∏—Ç–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–π—Ç–∞—Ö (–≤—ã—à–µ ‚Äì –±–æ–ª—å—à–µ)

## –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π

–¢–µ–ø–µ—Ä—å –º–æ–¥–µ–ª–∏ –æ–±—É—á–∞—é—Ç—Å—è –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –¥–≤—É—Ö –º–µ—Ç—Ä–∏–∫: –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ (time) –∏ –æ–±—ä–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö (size). –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –º–æ–¥–µ–ª–∏: Ridge, Lasso, RandomForest, GradientBoost, XGBoost –∏ CatBoost.

1. –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö

    –ó–∞–ø—É—Å—Ç–∏—Ç—å

    ```
    scripts/a_collect_sql_plans.py
    ```

    –æ–Ω–æ —Å–æ–±–µ—Ä—ë—Ç EXPLAIN ANALYZE –≤—Å—ë-—á—Ç–æ-–º–æ–∂–Ω–æ-—Å–æ–±—Ä–∞—Ç—å –≤
    `train_query_plans.csv` –∏–∑ –ø–∞–ø–∫–∏ `benchmarks/tpc-h/generated` –∏ `test_query_plans.csv` –∏–∑
    –ø–∞–ø–∫–∏ `benchmarks/tpc-h/queries`. –ü—Ä–æ—Ü–µ—Å—Å –¥–æ–ª–≥–∏–π, –ø—Ä–∏–¥—ë—Ç—Å—è –ø–æ–¥–æ–∂–¥–∞—Ç—å. –û—Å—Ç–∞–ª—å–Ω—ã–µ –±—ã—Å—Ç—Ä—ã–µ.

2. –û–±–æ–≥–∞–∏—Ç—å –¥–∞—Ç–∞—Å–µ—Ç—ã —Ñ–∏—á–∞–º–∏

    ```
    python scripts/b_enrich_dataset.py datasets/train_query_plans.csv > train_dataset.csv
    ```

3. –û–±—É—á–∏—Ç—å –º–æ–¥–µ–ª—å–∫–∏

    ```
    python scripts/c_train_models.py datasets/train_dataset.csv
    ```

4. –ó–∞–≥—Ä—É–∑—á–∏–∫ –º–æ–¥–µ–ª–µ–π –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–∫

    ```
    python ml/loader.py benchmarks/tpc-h/queries/q15.sql
    ```

–î–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫ –º–æ–¥–µ–ª–µ–π —Å–º. [–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –º–µ—Ç—Ä–∏–∫](C—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è\ —Ç–∞–±–ª–∏—Ü–∞\ –º–µ—Ç—Ä–∏–∫.md)

## –°—Å—ã–ª–∫–∏

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã**

* [pganalyze](https://pganalyze.com)
* [PostgreSQL Workload Analyzer](https://github.com/powa-team/powa)
* [pgMustard](https://www.pgmustard.com)
* [FlameExplain](https://flame-explain.com)
* [PEV2](https://github.com/dalibo/pev2)
* [SQLSolver: Proving Query Equivalence Using Linear Integer Arithmetic](https://github.com/SJTU-IPADS/SQLSolver)
* [QED, the Query Equivalence Decider](https://github.com/qed-solver)

**–ë–µ–Ω—á–º–∞—Ä–∫–∏ –∏ –¥–∞–Ω–Ω—ã–µ**

* [The CTU Prague Relational Learning Repository](https://relational.fel.cvut.cz)
* [DSB Benchmark](https://github.com/microsoft/dsb)
* [A Benchmark for Real-Time Analytics Applications](https://github.com/timescale/rtabench)
* [TPC-DS benchmark kit with some modifications/fixes](https://github.com/gregrahn/tpcds-kit)
* [Supplementary materials for SlabCity: Whole-Query Optimization using Program Synthesis](https://github.com/eidos06/SlabCity)

**–ú–æ–¥–µ–ª–∏**

* [Zero-Shot Cost Estimation Models](https://github.com/DataManagementLab/zero-shot-cost-estimation)
* [LLM for Index Recommendation](https://github.com/XinxinZhao798/LLMIndexAdvisor)
* [R-Bot: An LLM-based Query Rewrite System](https://github.com/curtis-sun/LLM4Rewrite)
* [LLMOpt: Query Optimization utilizing Large Language Models](https://github.com/lucifer12346/LLMOpt)
